$(document).on("turbolinks:load", function() {
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        },
    });

    $(document).ajaxError(function (event, jqxhr, settings, thrownError) {
        if (jqxhr.status === 401) {
            Turbolinks.visit('/');
        }

        if (jqxhr.status === 419) {
            Turbolinks.visit(location.toString());
        }
    });
});

function ajaxRequest(url, data = null, options = {}) {
    let jqxhr = $.ajax({
        type: options.method || 'POST',
        url: url,
        dataType: options.dataType || 'json',
        data: data,
        cache: false,
        async: typeof options.async !== 'undefined' ? options.async : true,
    });

    jqxhr.done(function(response) {
        if (options.callback || false) {
            options.callback(response);
        }
    });

    jqxhr.fail(function(response) {
        if (options.failCallback || false) {
            options.failCallback(response);
        }
    });

    return jqxhr.responseJSON;
}

function replace_template( template, data ) {
    return template.replace(
        /{(\w*)}/g,
        function( m, key ){
            return data.hasOwnProperty( key ) ? data[ key ] : "";
        }
    );
}

function process_each(elements, cb, timeout, options = {}) {
    let i = 0;
    let l = elements.length;

    (function fn() {
        let result = cb.call(elements[i++]);
        if (i < l) {
            setTimeout(fn, timeout);
        } else {
            if (options.completeCallback || false) {
                options.completeCallback(result);
            }
        }
    }());
}

function random_string(length) {
    let result = '';
    let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    let charactersLength = characters.length;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() *
            charactersLength));
    }
    return result;
}

toastr.options.timeOut = 3000;

function toastr_message(message, status, title = null) {
    if (status == true) {
        toastr.success(message, title || juzaweb.lang.successfully + ' !!');
    } else {
        toastr.error(message, title || juzaweb.lang.error + ' !!');
    }
}

function confirm_message(question, callback) {
    Swal.fire({
        title: '',
        text: question,
        type: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: juzaweb.lang.yes + '!',
        cancelButtonText: juzaweb.lang.cancel + '!',
    }).then((result) => {
        callback(result.value);
    });
}

function show_message(response) {
    // Show response message
    if (response.data) {
        if (response.data.message) {
            toastr_message(response.data.message, response.status);
        }
        return false;
    }

    // Show message validate
    if (response.responseJSON) {
        if (response.responseJSON.errors) {
            $.each(response.responseJSON.errors, function (index, msg) {
                toastr_message(msg[0], false);
                return false;
            });
        }

        else if (response.responseJSON.message) {
            toastr_message(response.responseJSON.message, false);
            return false;
        }
    }

    // Show message errors
    if (response.message) {
        toastr_message(response.message.message, false);
    }
}
$(document).on("turbolinks:load", function() {

    $("body").on('click', '.custom-seo', function () {
        let item = $(this);
        let title = $('input[name=title]').val();
        let description = tinyMCE.activeEditor.getContent();

        if ($("#meta_title").val() && $("#meta_description").val()) {
            item.hide('slow');
            $(".box-custom-seo").show('slow');
            return false;
        }

        $.ajax({
            type: 'POST',
            url: juzaweb.adminUrl + '/ajax/seo-content',
            dataType: 'json',
            data: {
                'title': title,
                'description': description,
            }
        }).done(function(data) {

            if (data.status === false) {
                show_message(data);
                return false;
            }
            
            if (!$("#meta_title").val()) {
                $("#meta_title").val(data.title);
            }

            if (!$("#meta_description").val()) {
                $("#meta_description").val(data.description);
            }

            if (!$("#meta_title").val()) {
                $(".review-title").text(data.title);
            }

            if (!$("#meta_description").val()) {
                $(".review-description").text(data.description);
            }

            item.hide('slow');
            $(".box-custom-seo").show('slow');
            return false;
        }).fail(function(data) {
            show_message(data);
            return false;
        });
    });

    $("input[name=title], textarea[name=content]").on('change', function () {
        let title = $('input[name=title]').val();
        let description = tinyMCE.activeEditor.getContent();

        $.ajax({
            type: 'POST',
            url: juzaweb.adminUrl + '/ajax/seo-content',
            dataType: 'json',
            data: {
                'title': title,
                'description': description,
            }
        }).done(function(data) {

            if (data.status === false) {
                show_message(data);
                return false;
            }

            if (!$("#meta_title").val()) {
                $(".review-title").text(data.title);
            }

            if (!$("#meta_description").val()) {
                $(".review-description").text(data.description);
            }

            return false;
        }).fail(function(data) {
            show_message(data);
            return false;
        });
    });

    $('form').on('change', 'input[name=slug]', function () {
        let slug = $(this).val();
        $(".review-url span").text(slug);
    });

    $("#meta_title, #meta_description, #meta_url").on('change', function () {
        let title = $('#meta_title').val();
        let description = $('#meta_description').val();

        $.ajax({
            type: 'POST',
            url: juzaweb.adminUrl + '/ajax/seo-content',
            dataType: 'json',
            data: {
                'title': title,
                'description': description
            }
        }).done(function(data) {

            if (data.status === false) {
                show_message(data.message);
                return false;
            }

            $(".review-title").text(data.title);
            $(".review-description").text(data.description);
            //$(".review-url span").text(data.slug);
            //if (!$("#meta_url").val()) $("#meta_url").val(data.slug);
            return false;
        }).fail(function(data) {
            show_message(data);
            return false;
        });
    });

});
let juzawebFileManager = function (options, cb) {
    let type = options.type || 'image';
    let routePrefix = options.prefix;
    let multichoose = options.multichoose || false;

    if (routePrefix[0] !== '/') {
        routePrefix = '/' + routePrefix;
    }

    let dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
    let w = options.width ? options.width : 800;
    let h = options.height ? options.height : 500;
    let dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;
    let width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    let height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;
    let systemZoom = width / window.screen.availWidth;
    let left = (width - w) / 2 / systemZoom + dualScreenLeft;
    let top = (height - h) / 2 / systemZoom + dualScreenTop;

    window.open(routePrefix + '?type=' + type + (multichoose ? '&multichoose=1' : ''), 'File Manager', 'scrollbars=yes, width=' + w / systemZoom + ', height=' + h / systemZoom + ', top=' + top + ', left=' + left);
    window.SetUrl = cb;
};

$.fn.filemanager = function(type, options) {
    let element = this;
    let prefix = juzaweb.adminPrefix + '/file-manager';
    this.on('click', function(e) {
        juzawebFileManager({
            type: type,
            prefix: prefix
        }, function (files) {
            let file = files[0];

            if (element.data('input')) {
                let targetInput = $('#' + element.data('input'));
                targetInput.val(file.path);
            }

            if (element.data('preview')) {
                let targetPreview = $('#' + element.data('preview'));
                targetPreview.html('<img src="'+ file.url +'" alt="'+ file.name +'">');
            }

            if (element.data('name')) {
                let targetName = $('#' + element.data('name'));
                targetName.html(file.name);
            }
        });
    });
};

$(document).on("turbolinks:load", function() {
    $('body').on('click', '.file-manager', function () {
        let type = $(this).data('type') || 'image';
        let input = $(this).data('input');
        let preview = $(this).data('preview');
        let name = $(this).data('name');
        let prefix = juzaweb.adminPrefix + '/file-manager';

        juzawebFileManager({
            type: type,
            prefix: prefix
        }, function (files) {
            let file = files[0];

            if (input) {
                let targetInput = $('#' + input);
                targetInput.val(file.path);
            }

            if (preview) {
                let targetPreview = $('#' + preview);
                targetPreview.html('<img src="'+ file.url +'" alt="">');
            }

            if (name) {
                let targetName = $('#' + name);
                targetName.html(file.name);
            }
        });
    });

    $('body').on('click', '.form-image', function () {
        let item = $(this);
        let targetInput = item.find('.input-path');
        let targetPreview = item.find('.dropify-render');
        let targetName = item.find('.dropify-filename-inner');
        let prefix = juzaweb.adminPrefix + '/file-manager';

        juzawebFileManager({
            type: 'image',
            prefix: prefix
        }, function (files) {
            let file = files[0];
            targetInput.val(file.path);
            targetPreview.html('<img src="'+ file.url +'" alt="">');
            targetName.html(file.name);
            item.addClass('previewing');
            item.find('.image-hidden').show();
        });
    });

    $('body').on('click', '.form-image .image-clear', function () {
        let item = $(this).closest('.form-image');
        let targetInput = item.find('.input-path');
        let targetPreview = item.find('.dropify-render');
        let targetName = item.find('.dropify-filename-inner');
        targetInput.val("");
        targetPreview.html('');
        targetName.html("");
        item.removeClass('previewing');
        item.find('.image-hidden').hide();
    });
    
    $('body').on('click', '.add-image-images', function () {
        let prefix = juzaweb.adminPrefix + '/file-manager';
        let item = $(this).closest('.form-images');
        let inputName = item.find('.input-name').val();
        
        juzawebFileManager({
            type: 'image',
            prefix: prefix,
            multichoose: true
        }, function (files) {
            let temp = document.getElementById('form-images-template').innerHTML;
            let str = "";
            
            $.each(files, function (index, item) {
                str += replace_template(temp, {
                    name: inputName,
                    url: item.url,
                    path: item.path
                });
            });
            
            item.find('.images-list .image-item:last').before(str);
        });
    });
    
    $('body').on('click', '.form-images .remove-image-item', function () {
        $(this).closest('.image-item').remove();
    });
});
$(document).on("turbolinks:load", function() {
    $('.jw-widget-builder').nestable({
        noDragClass: 'dd-nodrag',
        maxDepth: 1,
    });

    $('#widget-container').on('click', '.dropdown-action', function () {
        let blocks = $(this).closest('.widget-block').find('.sidebar-blocks');
        if (blocks.is(':hidden')) {
            blocks.show();
        } else {
            blocks.hide();
        }
    });

    $('#widget-container').on('submit', '.form-add-widget', function () {
        let form = $(this).serialize();
        let btn = $(this).find('button[type=submit]');
        let icon = btn.find('i').attr('class');

        btn.find('i').attr('class', 'fa fa-spinner fa-spin');
        btn.prop("disabled", true);

        ajaxRequest(juzaweb.adminUrl + '/widgets/get-item', form, {
            method: 'GET',
            callback: function(response) {
                let items = response.items || [];
                $.each(items, function (key, item) {
                    $('#sidebar-' + key + ' .jw-widget-builder .dd-empty').remove();
                    $('#sidebar-' + key + ' .dd-list').append(item.html);
                });

                $.each(items, function (key, item) {
                    initSelect2('#dd-item-' + item.key);
                });

                btn.find('i').attr('class', icon);
                btn.prop("disabled", false);
            },
            failCallback: function () {
                show_message(response);
                btn.find('i').attr('class', icon);
                btn.prop("disabled", false);
            }
        });

        return false;
    });

    $('#widget-container').on(
        'click',
        '.widget-sidebar-item',
        function () {
            let item = $(this);
            let isChecked = item.find('input').is(':checked');
            let form = item.closest('.form-add-widget');
            let btn = form.find('button[type=submit]');

            if (isChecked) {
                item.find('span').html('');
                item.find('input').prop('checked', false);
            } else {
                item.find('span').html(`<i class="fa fa-check"></i>`);
                item.find('input').prop('checked', true);
            }

            if (form.find('.widget-sidebar-item input:checked').length > 0) {
                btn.prop('disabled', false);
            } else {
                btn.prop('disabled', true);
            }
        }
    );

    $('#widget-container').on('click', '.show-edit-form', function () {
        let item = $(this);
        let form = item.closest('.sidebar-item').find('.card-body');
        if (form.is(':hidden')) {
            form.show();
        } else {
            form.hide();
        }
    });

    $('#widget-container').on('click', '.show-item-form', function () {
        let editForm = $(this).closest('.dd-item').find('.form-item-edit');
        if (editForm.is(':hidden')) {
            editForm.show();
        } else {
            editForm.hide();
        }
    });

    $('#widget-container').on(
        'click',
        '.delete-item-form',
        function () {
            $(this).closest('.dd-item').remove();
        }
    );
});

$(document).on("turbolinks:load", function() {
    $('#media-container').on('click', '.show-form-upload', function () {
        let form = $('.media-upload-form');

        if (form.is(':hidden')) {
            form.show('slow');
        } else {
            form.hide('slow');
        }
    })
});
$(document).on("turbolinks:load", function() {
    var updateOutput = function(e) {
        var list = e.length ? e : $(e.target);
        if (window.JSON) {
            $('#items-output').val(window.JSON.stringify(list.nestable('serialize')));
        } else {
            alert('JSON browser support required for this application.');
        }
    };

    $('#jw-menu-builder').nestable({
        noDragClass: 'dd-nodrag',
    }).on('change', updateOutput);

    updateOutput($('#jw-menu-builder'));

    $('#menu-container').on('submit', '.form-menu-block', function(event) {
        if (event.isDefaultPrevented()) {
            return false;
        }

        event.preventDefault();
        var form = $(this);
        var formData = new FormData(form[0]);
        var btnsubmit = form.find("button[type=submit]");
        var currentIcon = btnsubmit.find('i').attr('class');

        btnsubmit.find('i').attr('class', 'fa fa-spinner fa-spin');
        btnsubmit.prop("disabled", true);

        $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            dataType: 'json',
            data: formData,
            cache:false,
            contentType: false,
            processData: false
        }).done(function(response) {

            btnsubmit.find('i').attr('class', currentIcon);
            btnsubmit.prop("disabled", false);

            if (response.status === false) {
                show_message(response);
                return false;
            }

            let items = response.data.items;
            if (items.length > 0) {
                $('#jw-menu-builder .dd-empty').remove();

                $.each(items, function (index, item) {
                    $('#jw-menu-builder .dd-list:first').append(item);
                });
            }

            updateOutput($('#jw-menu-builder'));
            form.find('.reset-after-add').val('');

            return false;
        }).fail(function(response) {
            btnsubmit.find('i').attr('class', currentIcon);
            btnsubmit.prop("disabled", false);

            show_message(response);
            return false;
        });
    });

    $('#menu-container').on('click', '.btn-add-menu', function () {
        let eForm = $('.form-add-menu');
        if (eForm.is(':hidden')) {
            eForm.show('slow');
        } else {
            eForm.hide('slow');
        }
    });

    $('#menu-container').on('change', '.form-select-menu .load-menu', function () {
        let id = $(this).val();
        if (id) {
            window.location = juzaweb.adminUrl + "/menus/" + id;
        }
    });

    $('#menu-container').on('click', '.card-menu-show', function () {
        let cardBody = $(this).closest('.card-menu-items').find('.card-body');
        if (cardBody.is(':hidden')) {
            $('.card-menu-items').find('.card-body').slideUp('slow');
            $('.card-menu-items').find('.card-header').removeClass('bg-light');
            $(this).closest('.card-menu-items').find('.card-header').addClass('bg-light');
            cardBody.slideDown('slow');
        } else {
            cardBody.slideUp('slow');
            $(this).closest('.card-menu-items').find('.card-header').removeClass('bg-light');
        }
    });

    $('#menu-container').on('click', '.show-menu-edit', function (e) {
        let formEdit = $(this).closest('.dd-item').find('.form-item-edit').first();
        if (formEdit.is(':hidden')) {
            formEdit.slideDown('slow');
        } else {
            formEdit.slideUp('slow');
        }
    });

    $('#menu-container').on('click', '.delete-menu', function (e) {
        let id = $(this).data('id');

        confirm_message(
            juzaweb.lang.remove_question.replace(':name', juzaweb.lang.menu),
            function (result) {
                if (result) {
                    ajaxRequest(
                        juzaweb.adminUrl + "/menus/" + id,
                        {},
                        {
                            'method': 'DELETE',
                            'callback': function (response) {
                                show_message(response);
                                window.location = juzaweb.adminUrl + "/menus";
                            }
                        }
                    );
                }
            }
        );
    });

    $('#menu-container').on('change', '.menu-data', function () {
        let name = $(this).data('name');
        let val = $(this).val();

        $(this).closest('li').data(name, val);
        updateOutput($('#jw-menu-builder'));

        if ($(this).hasClass('change-label')) {
            $(this).closest('li').find('.dd-handle span:first').text(val);
        }
    });

    $('#menu-container').on('click', '.delete-menu-item', function () {
        $(this).closest('li').remove();
        updateOutput($('#jw-menu-builder'));
    });

    $('#menu-container').on('click', '.close-menu-item', function () {
        let formEdit = $(this).closest('.dd-item').find('.form-item-edit').first();
        if (formEdit.is(':hidden')) {
            formEdit.slideDown('slow');
        } else {
            formEdit.slideUp('slow');
        }
    });

    $('#menu-container').on('change', '.select-all-checkbox', function () {
        let select = $(this).data('select');
        let checked = $(this).is(':checked');
        $(this).closest('.tab-pane').find('.' + select).prop('checked', checked);
    });

    $('#menu-container').on('keyup', '.menu-box-post-type-search', function () {
        let search = $(this).val();
        let key = $(this).data('key');
        let postType = $(this).data('post_type');
        let resultElement = $(this)
            .closest('.tab-pane')
            .find('.box-tab-search-result');
        resultElement.html('');
        
        if (search.length <= 0) {
            return false;
        }

        ajaxRequest(juzaweb.adminUrl +'/load-data/loadPostType', {
            search: search,
            per_page: 5,
            post_type: postType
        }, {
            method: 'GET',
            callback: function (response) {
                let temps = '';
                $.each(response.results, function (index, item) {
                    temps += `<div class="form-check mt-1">
                        <label class="form-check-label">
                            <input class="form-check-input select-all-search-${key}" type="checkbox" name="items[]" value="${item.id}">
                            ${item.text}
                        </label>
                    </div>`;
                });

                resultElement.html(temps);

                return false;
            }
        });

        return false;
    });
    
    $('#menu-container').on('keyup', '.menu-box-taxonomy-search', function () {
        let search = $(this).val();
        let key = $(this).data('key');
        let taxonomy = $(this).data('taxonomy');
        let resultElement = $(this)
            .closest('.tab-pane')
            .find('.box-tab-search-result');
        resultElement.html('');
        
        if (search.length <= 0) {
            return false;
        }
        
        ajaxRequest(juzaweb.adminUrl +'/load-data/loadTaxonomies', {
            search: search,
            per_page: 5,
            taxonomy: taxonomy
        }, {
            method: 'GET',
            callback: function (response) {
                let temps = '';
                $.each(response.results, function (index, item) {
                    temps += `<div class="form-check mt-1">
                        <label class="form-check-label">
                            <input class="form-check-input select-all-search-${key}" type="checkbox" name="items[]" value="${item.id}">
                            ${item.text}
                        </label>
                    </div>`;
                });
                
                resultElement.html(temps);
                
                return false;
            }
        });
        
        return false;
    });
});
function jwUpdateProcess(
    processElement,
    message = null,
    percent = 0,
    status = 'primary'
) {
    if (message) {
        $(processElement + ' .process-text').append(`<li class="text-${status}">${message}</li>`);
    }

    if (percent) {
        $(processElement + ' .progress-bar')
            .attr('aria-valuenow', percent)
            .text(percent + '%')
            .css('width', percent + '%');
    }
}

function jwCMSUpdate(
    type,
    step,
    processElement = null,
    params = {},
    successCallback = null,
    failCallback = null
) {
    let cmsUpdateUrl = juzaweb.adminUrl + '/update/'+type+'/__STEP__';

    if (processElement) {
        jwUpdateProcess(
            processElement,
            juzaweb.lang.update_process['step'+step].before
        )
    }

    ajaxRequest(cmsUpdateUrl.replace('__STEP__', step), params, {
        method: 'POST',
        callback: function (response) {
            if(response.status == false) {
                if (failCallback) {
                    failCallback(response);
                }

                if (processElement) {
                    jwUpdateProcess(
                        processElement,
                        response.data.message,
                        0,
                        'danger'
                    );
                }
                return false;
            }

            if(response.data.next_url) {
                if (processElement) {
                    jwUpdateProcess(processElement, null, step * 17);
                }

                jwCMSUpdate(
                    type,
                    step+1,
                    processElement,
                    params,
                    successCallback,
                    failCallback
                );
            } else {
                if (successCallback) {
                    successCallback(response);
                }

                if (processElement) {
                    jwUpdateProcess(
                        processElement,
                        juzaweb.lang.update_process.done,
                        100,
                        'success'
                    );
                }
            }
        },
        failCallback: function (response) {
            let message = response.message || 'Server Error';
            if (failCallback) {
                failCallback(response);
            }

            if (processElement) {
                jwUpdateProcess(
                    processElement,
                    message,
                    step * 15,
                    'danger'
                );
            }
        }
    })
}

function recursiveUpdate(
    type,
    items,
    updateIndex = 0,
    successCallback = null,
    failCallback = null
) {
    let params = {};
    if (type == 'theme') {
        params = {theme: items[updateIndex]};
    } else {
        params = {plugin: items[updateIndex]};
    }

    jwCMSUpdate(
        type,
        1,
        '#'+type+'-'+ items[updateIndex].replace('/', '_') +'-update-process',
        params,
        function (response) {
            if (items[updateIndex+1]) {
                recursiveUpdate(type, items, updateIndex + 1, successCallback, failCallback);
            } else {
                if (successCallback) {
                    successCallback(response);
                }
            }
        },
        function (response) {
            if (failCallback) {
                failCallback(response);
            }

            if (items[updateIndex+1]) {
                recursiveUpdate(type, items, updateIndex + 1, successCallback, failCallback);
            }
        }
    );
}

$(document).on("turbolinks:load", function() {
    let bodyElement = $('body');
    bodyElement.on('click', '.install-plugin', function () {
        let plugin = $(this).data('plugin');
        let btn = $(this);
        let btnText = btn.html();
        btn.prop("disabled", true);
        btn.html('<i class="fa fa-spinner fa-spin"></i> ' + juzaweb.lang.please_wait);

        jwCMSUpdate(
            'plugin',
            1,
            null,
            {plugin: plugin},
            function (response) {
                btn.html(juzaweb.lang.activate);
                btn.removeClass('install-plugin');
                btn.addClass('active-plugin');
                btn.prop("disabled", false);
            },
            function(response) {
                show_message(response);
                btn.prop("disabled", false);
                btn.html(btnText);
            }
        );
    });

    bodyElement.on('click', '.active-plugin', function () {
        let plugin = $(this).data('plugin');
        let btn = $(this);
        btn.prop("disabled", true);

        ajaxRequest(juzaweb.adminUrl + '/plugins/bulk-actions', {
            ids: [plugin],
            action: 'activate',
        }, {
            method: 'POST',
            callback: function (response) {
                show_message(response);
                btn.html(`<i class="fa fa-check"></i> ${juzaweb.lang.activated}`);
                btn.removeClass('active-plugin');
                btn.prop("disabled", true);
            },
            failCallback: function(response) {
                show_message(response);
                btn.prop("disabled", false);
            }
        });
    });
});

$(document).on("turbolinks:load", function() {
    let bodyElement = $('body');

    bodyElement.on('click', '.update-theme', function () {
        let theme = $(this).data('theme');
        let btn = $(this);
        let btnText = btn.html();
        btn.prop("disabled", true);
        btn.html('<i class="fa fa-spinner fa-spin"></i> ' + juzaweb.lang.please_wait);

        jwCMSUpdate(
            'theme',
            1,
            null,
            {theme: theme},
            function (response) {
                btn.remove();
                show_message(response);
            },
            function (response) {
                btn.prop("disabled", false);
                btn.html(btnText);
                show_message(response);
            }
        );
    });

    bodyElement.on('click', '.install-theme', function () {
        let theme = $(this).data('theme');
        let btn = $(this);
        let btnText = btn.html();
        btn.prop("disabled", true);
        btn.html('<i class="fa fa-spinner fa-spin"></i> ' + juzaweb.lang.please_wait);

        jwCMSUpdate(
            'theme',
            1,
            null,
            {theme: theme},
            function (response) {
                btn.html(juzaweb.lang.activate);
                btn.removeClass('install-theme');
                btn.addClass('active-theme');
                btn.prop("disabled", false);
            },
            function(response) {
                show_message(response);
                btn.prop("disabled", false);
                btn.html(btnText);
            }
        );
    });

    bodyElement.on('click', '.active-theme', function () {
        let theme = $(this).data('theme');
        let btn = $(this);
        btn.prop("disabled", true);

        ajaxRequest(juzaweb.adminUrl + '/themes/activate', {
            theme: theme
        }, {
            method: 'POST',
            callback: function (response) {
                show_message(response);
                btn.html(`<i class="fa fa-check"></i> ${juzaweb.lang.activated}`);
                btn.removeClass('active-theme');
                btn.prop("disabled", true);
            },
            failCallback: function(response) {
                show_message(response);
                btn.prop("disabled", false);
            }
        });
    });

    bodyElement.on('click', '.delete-theme', function () {
        let theme = $(this).data('theme');
        let btn = $(this);
        let btnText = btn.html();

        confirm_message(
            juzaweb.lang.delete_theme_confirm,
            function (result) {
                if (!result) {
                    return false;
                }

                btn.html('<i class="fa fa-spinner fa-spin"></i> ' + juzaweb.lang.please_wait);

                ajaxRequest(juzaweb.adminUrl + '/themes/bulk-actions', {
                    ids: [theme],
                    action: 'delete'
                }, {
                    method: 'POST',
                    callback: function (response) {
                        show_message(response);
                        if (response.status == true) {
                            btn.closest('.theme-list-item').remove();
                        }
                    },
                    failCallback: function(response) {
                        show_message(response);
                        btn.html(btnText);
                    }
                });
        });
    });
});

function initSelect2(parent = 'body')
{
    $(parent +' .select2').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function (params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
    });

    $(parent +' .select2-default').select2({
        width: $(this).data('width') || '100%',
        dropdownAutoWidth: $(this).data('width') ? false : true,
    });

    $(parent +' .load-taxonomies').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function(params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: juzaweb.adminUrl +'/load-data/loadTaxonomies',
            dataType: 'json',
            data: function (params) {
                let postType = $(this).data('post-type');
                let taxonomy = $(this).data('taxonomy');
                let explodes = $(this).data('explodes');
                if (explodes) {
                    explodes = $("." + explodes).map(function () {
                        return $(this).val();
                    }).get();
                }

                var query = {
                    search: $.trim(params.term),
                    page: params.page,
                    explodes: explodes,
                    post_type: postType,
                    taxonomy: taxonomy
                };
                return query;
            }
        }
    });

    $(parent +' .load-users').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function (params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: '/admin-cp/load-data/loadUsers',
            dataType: 'json',
            data: function (params) {
                let explodes = $(this).data('explodes') ? $(this).data('explodes') : null;
                if (explodes) {
                    explodes = $("." + explodes).map(function () {return $(this).val();}).get();
                }

                var query = {
                    search: $.trim(params.term),
                    page: params.page,
                    explodes: explodes,
                };

                return query;
            }
        },
    });

    $(parent +' .load-menu').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function (params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: '/admin-cp/load-data/loadMenu',
            dataType: 'json',
            data: function (params) {
                let explodes = $(this).data('explodes') ? $(this).data('explodes') : null;
                if (explodes) {
                    explodes = $("." + explodes).map(function () {return $(this).val();}).get();
                }

                var query = {
                    search: $.trim(params.term),
                    page: params.page,
                    explodes: explodes,
                };

                return query;
            }
        },
    });

    $(parent +' .load-pages').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function (params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: '/admin-cp/load-data/loadPages',
            dataType: 'json',
            data: function (params) {
                var query = {
                    search: $.trim(params.term),
                    page: params.page
                };

                return query;
            }
        },
    });

    $(parent +' .load-locales').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function (params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: '/admin-cp/load-data/loadLocales',
            dataType: 'json',
            data: function (params) {
                var query = {
                    search: $.trim(params.term),
                    page: params.page
                };

                return query;
            }
        },
    });

    $(parent +' .load-select2').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function (params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: $(this).data('url') || '',
            dataType: 'json',
            data: function (params) {
                var query = {
                    search: $.trim(params.term),
                    page: params.page
                };

                return query;
            }
        },
    });

    $(parent +' .load-resources').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function(params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: juzaweb.adminUrl +'/load-data/loadResource',
            dataType: 'json',
            data: function (params) {
                let type = $(this).data('type');
                let explodes = $(this).data('explodes');

                if (explodes) {
                    explodes = $("." + explodes).map(function () {
                        return $(this).val();
                    }).get();
                }

                let query = {
                    search: $.trim(params.term),
                    page: params.page,
                    explodes: explodes,
                    type: type
                };
                return query;
            }
        }
    });

    $(parent +' .load-subscription-objects').select2({
        allowClear: true,
        dropdownAutoWidth: $(this).data('width') ? false : true,
        width: $(this).data('width') || '100%',
        placeholder: function(params) {
            return {
                id: null,
                text: params.placeholder,
            }
        },
        ajax: {
            method: 'GET',
            url: juzaweb.adminUrl +'/load-data/loadSubscriptionObjects',
            dataType: 'json',
            data: function (params) {
                let module = $(this).data('module');

                let query = {
                    search: $.trim(params.term),
                    page: params.page,
                    module: module
                };

                return query;
            }
        }
    });
}

$(document).on("turbolinks:load", function() {
    initSelect2('body');
});

class JuzawebTable {

    constructor(e) {
        this.url = e.url;
        this.action_url = e.action_url;
        this.remove_url = e.remove_url || null;
        this.status_url = e.status_url || null;
        this.remove_question = (e.remove_question) ? e.remove_question: juzaweb.lang.remove_question.replace(':name', juzaweb.lang.the_selected_items);
        this.detete_button = (e.detete_button) ? e.detete_button : "#delete-item";
        this.status_button = (e.status_button) ? e.status_button : ".status-button";
        this.apply_button = (e.apply_button) ? e.apply_button: "#apply-action";
        this.table = (e.table) ? e.table : '.juzaweb-table';
        this.field_id = (e.field_id) ? e.field_id : 'id';
        this.form_search = (e.form_search) ? e.form_search : "#form-search";
        this.sort_name = (e.sort_name) ? e.sort_name : 'id';
        this.sort_order = (e.sort_order) ? e.sort_order : 'desc';
        this.page_size = (e.page_size) ? e.page_size: 10;
        this.search = (e.search) ? e.search : false;
        this.method = (e.method) ? e.method : 'get';
        this.locale = (e.locale) ? e.locale : 'en-US';
        this.chunk_action = (e.chunk_action) ? e.chunk_action : false;
        this.init();
    }

    init() {
        let apply_button = $(this.apply_button);
        let btn_status = $(this.status_button);

        apply_button.prop('disabled', true);
        btn_status.prop('disabled', true);

        let table = $(this.table);
        let form_search = this.form_search;
        let action_url = this.action_url;
        let remove_question = this.remove_question;
        let data_url = this.url;
        let field_id = this.field_id;
        let method = this.method;
        let locale = this.locale;
        let status_url = this.status_url;
        let chunk_action = this.chunk_action;

        table.bootstrapTable({
            url: data_url,
            idField: field_id,
            method: method,
            locale: locale,
            sidePagination: 'server',
            pagination: true,
            sortName: this.sort_name,
            sortOrder: this.sort_order,
            toggle: 'table',
            search: this.search,
            pageSize: this.page_size,
            queryParams: function (params) {
                let fieldSearch = $(form_search).serializeArray();
                $.each(fieldSearch, function (i, item) {
                    if (params[item.name]) {
                        params[item.name] += ',' + item.value;
                    } else {
                        params[item.name] = item.value;
                    }
                });
                return params;
            }
        });

        function action_button() {
            let tblSelection = !table.bootstrapTable('getSelections').length;
            apply_button.prop('disabled', tblSelection);
        }

        $(this.form_search).on('change', 'select, input', function (event) {
            if (event.isDefaultPrevented()) {
                return false;
            }

            event.preventDefault();
            table.bootstrapTable('refresh');
            return false;
        });

        $(this.form_search).on('submit', function (event) {
            if (event.isDefaultPrevented()) {
                return false;
            }

            event.preventDefault();
            table.bootstrapTable('refresh');
            return false;
        });

        table.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table ' +
            'pre-body.bs.table', () => {
            action_button();
        });

        apply_button.on('click', function () {
            let btn = $(this);
            let form = btn.closest('form');
            let text = btn.html();
            let action = form.find('select[name=bulk_actions]').val();
            let token = form.find('input[name=_token]').val();
            let ids = $("input[name=btSelectItem]:checked").map(function(){return $(this).val();}).get();

            if (!ids || !action) {
                return false;
            }

            if (action == 'delete') {
                confirm_message(remove_question, function (result) {
                    if (!result) {
                        return false;
                    }

                    btn.html(juzaweb.lang.please_wait);
                    btn.prop("disabled", true);

                    ajaxRequest(action_url, {
                        'ids': ids,
                        'action': action,
                        '_token': token
                    }, {
                        callback: function (response) {
                            btn.prop("disabled", false);
                            btn.html(text);

                            if (response.status === true) {
                                show_message(response);
                                table.bootstrapTable('refresh');
                                $('select[name=bulk_actions]').val(null).trigger('change.select2');
                                return false;
                            } else {
                                show_message(response);
                                return false;
                            }
                        }
                    });
                });
            } else {
                btn.html(juzaweb.lang.please_wait);
                btn.prop("disabled", true);

                if (chunk_action) {
                    let items = $("input[name=btSelectItem]:checked");
                    setTimeout(function () {
                        let response;
                        process_each(items, function () {
                            let id = $(this).val();
                            $(this).hide();
                            $(this).closest('label')
                                .find('span')
                                .html(`<i class="fa fa-spinner fa-spin"></i>`);

                            response = ajaxRequest(action_url, {
                                'ids': [id],
                                'action': action,
                                '_token': token
                            }, {
                                async: false,
                                callback: function (response) {
                                    return false;
                                }
                            });

                            return response;
                        }, 500, {
                            completeCallback: function (response) {
                                show_message(response);

                                if (response.data.redirect) {
                                    setTimeout(function () {
                                        Turbolinks.visit(response.data.redirect, {action: "replace"});
                                    }, 1000);
                                    return false;
                                }

                                if (response.data.window_redirect) {
                                    setTimeout(function () {
                                        window.location = response.data.window_redirect;
                                    }, 1000);
                                    return false;
                                }

                                btn.prop("disabled", false);
                                btn.html(text);

                                table.bootstrapTable('refresh');

                                $('select[name=bulk_actions]').val(null).trigger('change.select2');
                            }
                        });

                    }, 500);

                } else {
                    ajaxRequest(action_url, {
                        'ids': ids,
                        'action': action,
                        '_token': token
                    }, {
                        callback: function (response) {
                            if (response.status === true) {
                                show_message(response);

                                if (response.data.redirect) {
                                    setTimeout(function () {
                                        Turbolinks.visit(response.data.redirect, {action: "replace"});
                                    }, 1000);
                                    return false;
                                }

                                if (response.data.window_redirect) {
                                    setTimeout(function () {
                                        window.location = response.data.window_redirect;
                                    }, 1000);
                                    return false;
                                }

                                btn.prop("disabled", false);
                                btn.html(text);

                                table.bootstrapTable('refresh');
                                $('select[name=bulk_actions]').val(null).trigger('change.select2');
                                return false;
                            } else {
                                show_message(response);
                                return false;
                            }
                        }
                    });
                }
            }

            return false;
        });

        btn_status.on('click', function () {
            let ids = $("input[name=btSelectItem]:checked").map(function () {return $(this).val();}).get();
            let status = $(this).data('status');

            if (ids.length <= 0) {
                return false;
            }

            $.ajax({
                type: "POST",
                url: status_url,
                dataType: 'json',
                data: {
                    'ids': ids,
                    'status': status,
                },
                success: function (result) {
                    if (result.status === true) {
                        table.bootstrapTable('refresh');
                        btn_status.prop('disabled', true);
                        $('.items-checked').prop('disabled', true);
                        return false;
                    } else {
                        show_message(result);
                        return false;
                    }
                }
            });

            return false;
        });

        table.on('click', '.action-item', function () {
            let ids = [$(this).data('id')];
            let action = $(this).data('action');

            if (action == 'delete') {
                Swal.fire({
                    title: '',
                    text: remove_question,
                    type: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: juzaweb.lang.yes + '!',
                    cancelButtonText: juzaweb.lang.cancel + '!',
                }).then((result) => {
                    if (result.value) {
                        $(this).html(juzaweb.lang.please_wait);

                        $.ajax({
                            type: "POST",
                            url: action_url,
                            dataType: 'json',
                            data: {
                                'ids': ids,
                                'action': action
                            },
                            success: function (response) {
                                table.bootstrapTable('refresh');
                            }
                        });
                    }
                });
            } else {
                $(this).html(juzaweb.lang.please_wait);

                $.ajax({
                    type: "POST",
                    url: action_url,
                    dataType: 'json',
                    data: {
                        'ids': ids,
                        'action': action
                    },
                    success: function (response) {
                        table.bootstrapTable('refresh');
                    }
                });
            }

            return false;
        });
    }

    refresh(options = {}) {
        if (options) {
            $(this.table).bootstrapTable('refreshOptions', options);
        } else {
            $(this.table).bootstrapTable('refresh', options);
        }
    }
}

class JuzawebListView {
    constructor(e) {
        this.url = e.url;
        this.list = (e.list) ? e.list : '.juzaweb-list';
        this.method = (e.method) ? e.method : 'get';
        this.template = (e.template) ? e.template : '';
        this.sort_name = (e.sort_name) ? e.sort_name : 'id';
        this.sort_order = (e.sort_order) ? e.sort_order : 'desc';
        this.page_size = (e.page_size) ? e.page_size: 10;
        this.after_load_callback = (e.after_load_callback) ? e.after_load_callback: null;
        this.offset = 0;
        this.total = 0;
        this.page = 1;

        this.init();
    }

    init () {
        let item = this;
        item.loadData();

        $(window).scroll(function () {
            if ($(window).scrollTop() === $(document).height() - $(window).height()) {
                if (item.offset + item.page_size < item.total) {
                    item.page = item.page + 1;
                    item.loadData();
                }
            }
        });
    }

    loadData() {
        let template = document.getElementById(this.template).innerHTML;
        let result = $(this.list);

        if (this.page > 1) {
            this.offset = (this.page * this.page_size) - this.page_size;
        }

        let jqxhr = $.ajax({
            type: this.method,
            url: this.url,
            dataType: 'json',
            cache: false,
            async: false,
            data: {
                page: this.page,
                limit: this.page_size
            }
        });

        let response = jqxhr.responseJSON;
        this.total = response.meta.total;

        let html = '';
        if (response.data.length > 0) {
            $.each(response.data, function (index, item) {
                html += replace_template(template, item)
            });

            result.append(html);
        }

        if (this.after_load_callback) {
            eval(this.after_load_callback)();
        }
    }
}

/*
 * JUZAWEB CMS 1.0 - Form Ajax support
 *
 *
 * Copyright JS Foundation and other contributors
 * Released under the MIT license
 *
 * Date: 2021-03-12T21:04Z
 */

$(document).on("turbolinks:load", function() {
    $('body').on('submit', '.form-ajax', function(event) {
        if (event.isDefaultPrevented()) {
            return false;
        }

        event.preventDefault();

        var form = $(this);
        var formData = new FormData(form[0]);
        var btnsubmit = form.find("button[type=submit]");
        var currentIcon = btnsubmit.find('i').attr('class');
        var currentText = btnsubmit.html();
        var submitSuccess = form.data('success');

        btnsubmit.find('i').attr('class', 'fa fa-spinner fa-spin');
        btnsubmit.prop("disabled", true);

        if (btnsubmit.data('loading-text')) {
            btnsubmit.html('<i class="fa fa-spinner fa-spin"></i> ' + btnsubmit.data('loading-text'));
        }

        $.ajax({
            type: form.attr('method'),
            url: form.attr('action'),
            dataType: 'json',
            data: formData,
            cache:false,
            contentType: false,
            processData: false
        }).done(function(response) {

            show_message(response);

            if (submitSuccess) {
                eval(submitSuccess)(form, response);
            }

            if (response.data.redirect) {
                setTimeout(function () {
                    Turbolinks.visit(response.data.redirect, {action: "replace"});
                }, 1000);
                return false;
            }

            btnsubmit.find('i').attr('class', currentIcon);
            btnsubmit.prop("disabled", false);

            if (btnsubmit.data('loading-text')) {
                btnsubmit.html(currentText);
            }

            if (response.status === false) {
                return false;
            }

            return false;
        }).fail(function(response) {
            btnsubmit.find('i').attr('class', currentIcon);
            btnsubmit.prop("disabled", false);

            if (btnsubmit.data('loading-text')) {
                btnsubmit.html(currentText);
            }

            show_message(response);
            return false;
        });
    });

    $('body').on('click', '.load-modal', function(event) {
        if (event.isDefaultPrevented()) {
            return false;
        }

        event.preventDefault();
        let data = $(this).data();
        let btnsubmit = $(this);
        let currentIcon = btnsubmit.find('i').attr('class');

        btnsubmit.find('i').attr('class', 'fa fa-spinner fa-spin');
        btnsubmit.prop("disabled", true);
        btnsubmit.addClass("disabled");

        let query_str = '';
        $.each(data, function (index, item) {
            if (index !== 'url') {
                query_str += '&'+index+'='+item;
            }
        });

        let url = $(this).data('url');

        if (query_str) {
            url = url + "?"+query_str;
        }

        $.ajax({
            type: 'GET',
            url: url,
            dataType: 'json',
            data: {},
            cache:false,
            contentType: false,
            processData: false
        }).done(function(response) {

            btnsubmit.find('i').attr('class', currentIcon);
            btnsubmit.prop("disabled", false);
            btnsubmit.removeClass("disabled");

            if (response.status === false) {
                return false;
            }

            $('#show-modal').html(response.data.source);
            $('#show-modal .modal').modal();

            return false;
        }).fail(function(response) {
            btnsubmit.find('i').attr('class', currentIcon);
            btnsubmit.prop("disabled", false);

            /*show_message(response);*/
            return false;
        });
    });

    $("body").on('keypress', '.is-number', function () {
        return validate_isNumberKey(this);
    });

    $("body").on('keyup', '.number-format', function () {
        return validate_FormatNumber(this);
    });

    function validate_isNumberKey(evt) {
        let charCode = (evt.which) ? evt.which : event.keyCode;
        if (charCode == 59 || charCode == 46)
            return true;
        if (charCode > 31 && (charCode < 48 || charCode > 57))
            return false;
        return true;
    }

    function validate_FormatNumber(a) {
        a.value = a.value.replace(/\,/gi, "");
        a.value = a.value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
    }
});
$(document).on("turbolinks:load", function() {
    $('.form-taxonomy').on('click', '.add-new', function () {
        let formAdd = $(this).closest('.form-taxonomy').find('.form-add');
        if (formAdd.is(':visible')) {
            formAdd.hide('slow');
        } else {
            formAdd.show('slow');
        }
    });

    $('body').on('change', '.select-tags', function () {
        let item = $(this);
        let id = item.val();
        let taxonomy = item.data('taxonomy');
        let type = item.data('type');

        $.ajax({
            type: 'GET',
            url: juzaweb.adminUrl + '/taxonomy/' + type +'/' + taxonomy + '/component-item',
            dataType: 'json',
            data: {
                'id': id
            }
        }).done(function(response) {
            if (response.status === false) {
                show_message(response);
                return false;
            }

            item.closest('.form-taxonomy')
                .find('.show-tags')
                .append(response.data.html);

            item.val(null).trigger('change.select2');

            return false;
        }).fail(function(response) {
            show_message(response);
            return false;
        });
    });

    $('body').on('click', '.remove-tag-item', function () {
        $(this).closest('.tag').remove();
    });

    $('body').on('click', '.form-add-taxonomy button', function () {
        let btn = $(this);
        let taxForm = btn.closest('.form-add');
        let name = taxForm.find('.taxonomy-name').val();
        let parent = taxForm.find('.taxonomy-parent').val();
        let type = btn.data('type');
        let taxonomy = btn.data('taxonomy');
        let postType = btn.data('post_type');
        let icon = btn.find('i').attr('class');

        btn.find('i').attr('class', 'fa fa-spinner fa-spin');
        btn.prop("disabled", true);

        $.ajax({
            type: 'POST',
            url: juzaweb.adminUrl + '/taxonomy/' + type +'/' + taxonomy,
            dataType: 'json',
            data: {
                name: name,
                parent_id: parent,
                post_type: postType,
                taxonomy: taxonomy,
            }
        }).done(function(response) {

            btn.find('i').attr('class', icon);
            btn.prop("disabled", false);

            if (response.status === false) {
                show_message(response);
                return false;
            }

            btn.closest('.form-taxonomy')
                .find('.show-tags')
                .append(response.data.html);

            taxForm.find('.taxonomy-name').val('');
            if (parent) {
                taxForm.find('.taxonomy-parent').val(null)
                    .trigger('change.select2');
            }

            return false;
        }).fail(function(response) {
            btn.find('i').attr('class', icon);
            btn.prop("disabled", false);

            show_message(response);
            return false;
        });
    });
});
$(document).on("turbolinks:load", function() {
    let bodyElement = $('body');

    bodyElement.on('change', '.show_on_front-change', function () {
        let showOnFront = $(this).val();

        if (showOnFront == 'posts') {
            $('.select-show_on_front').prop('disabled', true);
        }

        if (showOnFront == 'page') {
            $('.select-show_on_front').prop('disabled', false);
        }
    });

    bodyElement.on('click', '.cancel-button', function () {
        window.location = "";
    });

    bodyElement.on('change', '.generate-slug', function () {
        let title = $(this).val();

        ajaxRequest(juzaweb.adminUrl +'/load-data/generateSlug', {
            title: title
        }, {
            method: 'GET',
            callback: function (response) {
                $('input[name=slug]').val(response.slug).trigger('change');
            }
        });
    });

    bodyElement.on('click', '.slug-edit', function () {
        let slugInput = $(this).closest('.input-group').find('input:first');
        slugInput.prop('readonly', !slugInput.prop('readonly'));
    });

    bodyElement.on('click', '.close-message', function () {
        let id = $(this).data('id');
        ajaxRequest(juzaweb.adminUrl + '/remove-message', {
            id: id,
        }, {
            method: 'POST',
            callback: function (response) {

            }
        });
    });
});

$(document).on("turbolinks:load", function() {




});
$(document).on("turbolinks:load", function() {
    
    let urlParams = new URLSearchParams(window.location.search);
    let template = urlParams.get('template');
    
    if (template) {
        $('select[name="meta[template]"]').val(template).trigger('change');
    }
    
    $('body').on('click', '.show-form-block', function () {
        let form = $(this).closest('.dd-item').find('.form-block-edit');
        if (form.is(':hidden')) {
            form.show('slow');
        } else {
            form.hide('slow');
        }
    });
    
    $('body').on('click', '.remove-form-block', function () {
        $(this).closest('.dd-item').remove();
    });
    
    $('body').on('change', 'select[name="meta[template]"]', function () {
        let template = $(this).val();
        if (!template) {
            return false;
        }
        
        let currentUrl = window.location.href;
        currentUrl = currentUrl.split("?")[0];
        
        Turbolinks.visit(currentUrl + '?template=' + template, {action: "replace"});
    });

    $('body').on('click', '.add-block-data', function () {
        let block = $(this).data('block');
        let contentKey = $(this).data('content_key');
        let item = $(this);
        let template = document.getElementById('block-'+ block + '-template').innerHTML;
        let marker = (new Date()).getTime();
        template = replace_template(template, {
            'marker': marker,
            'content_key': contentKey,
        });
    
        item.closest('.page-block-content').find('.dd-empty').remove();
        item.closest('.page-block-content').find('.dd-list').append(template);
    
        initSelect2('#page-block-' + marker);
    });
    
});